<div class="resolucion-detail-container">
  <div *ngIf="loading" class="loading-container">
    <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
    <p>Cargando resolución...</p>
  </div>
  <div *ngIf="!loading && resolucion">
    <div class="detail-header">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
  <h1>Resolución {{ resolucion.Titulo || 'Resolución' }}</h1>
    </div>
    <!-- Custom Tabs Header (fixed) -->
    <div class="custom-tab-header-wrapper">
      <div class="custom-tab-header">
        <div *ngFor="let tab of tabs; let i = index"
             #tabLabel
             class="custom-tab-label"
             [class.active]="selectedTabIndex === i"
             (click)="selectTab(i)">
          <mat-icon *ngIf="tab.icon">{{tab.icon}}</mat-icon>
          {{tab.label}}
          <mat-chip *ngIf="tab.chip && tab.chipValue" class="count-chip">{{tab.chipValue}}</mat-chip>
        </div>
        <div class="custom-tab-underline" [style.width.px]="underlineWidth" [style.transform]="'translateX(' + underlineLeft + 'px)'"></div>
      </div>
    </div>
    <div class="custom-tab-content-wrapper">
      <div [@slideContent]="selectedTabIndex">
        <ng-container [ngSwitch]="selectedTabIndex">
          <!-- Información General -->
          <ng-container *ngSwitchCase="0">
            <div class="tab-content">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>Datos Básicos</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="info-grid">
                    <div class="info-item"><label>N° Resolución:</label><span>{{ resolucion.Numero || 'Sin número' }}</span></div>
                    <div class="info-item"><label>Título:</label><span>{{ resolucion.Titulo || 'Sin título' }}</span></div>
                    <div class="info-item"><label>Estado:</label><span>{{ resolucion.Estado || 'Sin estado' }}</span></div>
                    <div class="info-item"><label>Fecha de Emisión:</label><span>{{ resolucion.Fecha_emision ? (resolucion.Fecha_emision | date:'dd/MM/yyyy') : 'Sin fecha' }}</span></div>
                    <div class="info-item"><label>Fecha de Publicación:</label><span>{{ resolucion.Fecha_publicacion ? (resolucion.Fecha_publicacion | date:'dd/MM/yyyy') : 'Sin fecha' }}</span></div>
                    <div class="info-item"><label>Organismo Emisor:</label><span>{{ resolucion.Organismo_emisor || 'Sin organismo' }}</span></div>
                    <div class="info-item"><label>Contenido:</label><span>{{ resolucion.Contenido || 'Sin contenido' }}</span></div>
                    <div class="info-item"><label>Descripción:</label><span>{{ resolucion.Descripcion || 'Sin descripción' }}</span></div>
                    <div class="info-item"><label>Observaciones:</label><span>{{ resolucion.Observaciones || 'Sin observaciones' }}</span></div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </ng-container>
          <!-- Alertas -->
          <ng-container *ngSwitchCase="1">
            <div class="tab-content">
              <app-alertas-list [idTransaccion]="resolucion.IdTransaccion ?? null"></app-alertas-list>
            </div>
          </ng-container>
          <!-- Observaciones -->
          <ng-container *ngSwitchCase="2">
            <div class="tab-content">
              <app-observaciones-tab [idTransaccion]="resolucion.IdTransaccion ?? null"></app-observaciones-tab>
            </div>
          </ng-container>
          <!-- Archivos -->
          <ng-container *ngSwitchCase="3">
            <div class="tab-content">
              <mat-card>
                <mat-card-content>
                  <div class="archivos-header">
                    <h3>Archivos de la Resolución</h3>
                    <div *ngIf="!mostrarFormularioArchivoResolucion">
                      <button mat-raised-button color="primary" (click)="mostrarFormularioArchivoResolucion = true">
                        <mat-icon>cloud_upload</mat-icon>
                        Subir Archivo
                      </button>
                    </div>
                  </div>
                  <mat-card class="archivo-form" *ngIf="mostrarFormularioArchivoResolucion">
                    <mat-card-header>
                      <mat-card-title>Subir Archivo</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <form (ngSubmit)="subirArchivoResolucion()" #formArchivoResolucion="ngForm" autocomplete="off">
                        <div class="file-input-container">
                          <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 16px;">
                            <mat-label>Archivo seleccionado</mat-label>
                            <input matInput [value]="archivoSeleccionadoResolucion?.name || ''" readonly placeholder="Selecciona un archivo">
                            <button mat-icon-button matSuffix type="button" (click)="fileInputResolucion.click()">
                              <mat-icon>attach_file</mat-icon>
                            </button>
                          </mat-form-field>
                          <input type="file" #fileInputResolucion (change)="onArchivoSeleccionadoResolucion($event)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls" style="display: none">
                        </div>
                        <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 16px;">
                          <mat-label>Descripción (opcional)</mat-label>
                          <textarea matInput [(ngModel)]="descripcionArchivoResolucion" name="descripcionArchivoResolucion" rows="3" placeholder="Descripción del archivo" maxlength="150"></textarea>
                        </mat-form-field>
                        <div *ngIf="loadingArchivoResolucion" class="upload-progress">
                          <p>Subiendo archivo...</p>
                          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                        </div>
                        <div class="form-actions" style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 16px;">
                          <button mat-button type="button" (click)="cancelarSubidaArchivoResolucion()" [disabled]="loadingArchivoResolucion">Cancelar</button>
                          <button mat-raised-button color="primary" type="submit" [disabled]="!archivoSeleccionadoResolucion || loadingArchivoResolucion">
                            <mat-icon>cloud_upload</mat-icon>
                            Subir Archivo
                          </button>
                        </div>
                        <div *ngIf="errorArchivoResolucion" class="error-msg">{{ errorArchivoResolucion }}</div>
                      </form>
                    </mat-card-content>
                  </mat-card>
                  <ng-container *ngIf="!mostrarFormularioArchivoResolucion">
                    <app-archivo-edit
                      *ngIf="archivoResolucionEnEdicion"
                      [archivo]="archivoResolucionEnEdicion"
                      (archivoActualizado)="onArchivoResolucionActualizado($event)"
                      (cancelar)="archivoResolucionEnEdicion = null">
                    </app-archivo-edit>
                    <table mat-table [dataSource]="archivosResolucion" class="full-width-table" *ngIf="archivosResolucion.length > 0 && !archivoResolucionEnEdicion">
                      <ng-container matColumnDef="nombre">
                        <th mat-header-cell *matHeaderCellDef>Nombre</th>
                        <td mat-cell *matCellDef="let archivo">{{ archivo.Nombre }}</td>
                      </ng-container>
                      <ng-container matColumnDef="descripcion">
                        <th mat-header-cell *matHeaderCellDef>Descripción</th>
                        <td mat-cell *matCellDef="let archivo">{{ archivo.Descripcion || 'Sin descripción' }}</td>
                      </ng-container>
                      <ng-container matColumnDef="fecha">
                        <th mat-header-cell *matHeaderCellDef>Fecha</th>
                        <td mat-cell *matCellDef="let archivo">{{ formatFechaArgentina(archivo.AudFecha) }}</td>
                      </ng-container>
                      <ng-container matColumnDef="acciones">
                        <th mat-header-cell *matHeaderCellDef>Acciones</th>
                        <td mat-cell *matCellDef="let archivo">
                          <button mat-icon-button (click)="descargarArchivoResolucion(archivo)" title="Descargar">
                            <mat-icon>download</mat-icon>
                          </button>
                          <button mat-icon-button (click)="editarArchivoResolucion(archivo)" title="Editar">
                            <mat-icon>edit</mat-icon>
                          </button>
                        </td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="displayedColumnsArchivosResolucion"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedColumnsArchivosResolucion;"></tr>
                    </table>
                    <div *ngIf="archivosResolucion.length === 0 && !archivoResolucionEnEdicion" class="no-archivos">
                      <mat-icon>folder_open</mat-icon>
                      <p>No hay archivos subidos para esta resolución</p>
                    </div>
                    <mat-paginator
                      [length]="totalArchivosResolucion"
                      [pageSize]="pageSizeArchivosResolucion"
                      [pageSizeOptions]="[5, 10, 20, 50]"
                      [pageIndex]="paginaActualArchivosResolucion - 1"
                      (page)="onPageChangeArchivosResolucion($event)"
                      showFirstLastButtons>
                    </mat-paginator>
                  </ng-container>
                </mat-card-content>
              </mat-card>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</div>
